<div ng-controller="PageCtrl">

  <style type="text/css">
    ul.template_widget_list {
      list-style-type: none;
      margin-left: 5px;
    }
    ul.template_widget_list li {
      display: inline-block;
      float: left;
      margin-right: 3px;
      margin-left: 3px;
    }
    ul.template_widget_list li.list-top {
      margin-right: 0px;
      margin-left: 0px;
    }
    ul.template_widget_list li.newline + li {
      clear: left;
    }

    .cursor:after {
      content: "";
      border: 1px #999 solid;
      color: transparent;
      vertical-align: bottom;
      padding: 0 0.4em;
    }

    .boldit   .widget-format-target { font-weight: bold; }
    .italicit .widget-format-target { font-style: italic }
  </style>


  <ul class="breadcrumb">
    <li><a href="/user/{{userName}}" target="_self">Overview</a> <span class="divider">/</span></li>
    <li><a href="/user/{{userName}}/datasource/{{page.dataset_id}}" target="_self">Dataset: {{dataset.name}}</a> <span class="divider">/</span></li>
    <li>Page: {{page.title}}</li>
  </ul>


  <div class="navbar">
    <div class="navbar-inner">
      <ul class="nav">
        <li ng-class="{active: !editmode}"><a ng-click="editmode = 0" id="preview_mode" href="#">Preview</a></li>
        <li ng-class="{active:  editmode}"><a ng-click="editmode = 1" id="edit_mode" href="#">Edit</a></li>
        <li><a ng-class="{'save-disabled': !pageDirty, 'save-ready': pageDirty}" ng-click="updatePage()" href="#">Save</a></li>
      </ul>
    </div>
  </div>

  <alert ng-repeat="alert in alerts" type="alert.type" close="closeAlert($index)">{{alert.msg}}</alert>

  <div ng-show="editmode" class="editable_label" style="margin-bottom: -10px;">Page Title:</div>
  <h2 judoon-ckeditor ck-edit-type="inline" ng-class="{edit_outline: editmode}" ng-model="page.title" id="page_title" contenteditable="true" class="editable inline_editable"></h2>

  <div ng-show="editmode" class="editable_label">Preamble:</div>
  <div judoon-ckeditor ck-edit-type="block" ng-class="{edit_outline: editmode}" id="page_preamble" ng-model="page.preamble" contenteditable="true" class="editable block_editable"></div>
  <br>

  <div ng-show="editmode" class="table_edit_ctrls well well-small">

    <div class="row-fluid">
      <div class="span3">
        <form ng-submit="addColumn()" class="column_list">
          <h6>Add a new column</h6>
          <div class="input-append">
            <input type="text" placeholder="Column name" required ng-model="newColumnName">
            <button type="submit" class="btn">Add</button>
          </div>
        </form>
      </div>

      <div class="span1"></div>

      <div class="span3">
        <form class="column_list">
          <h6>Update an existing column</h6>
          <div class="input-append">
            <select ng-model="currentColumn" ng-options="c.title for c in pageColumns">
              <option value=""></option>
            </select>
          </div>
        </form>
      </div>

      <div class="span1"></div>

      <div class="span3">
        <form class="column_list">
          <h6 class="text-warning">Delete a column</h6>
          <div class="input-append">
            <select ng-model="deleteColumn" ng-options="c.title for c in pageColumns">
              <option value=""></option>
            </select>
            <button type="submit" ng-click="removeColumn()" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>

    <hr>

    <form ng-show="currentColumn" class="form-horizontal" ng-submit="updateColumn()">
      <div class="control-group">
        <label class="control-label" for="page.title">Title: </label>
        <div class="controls">
          <input type="text" class="span6" required name="page.title" id="page.title" ng-model="currentColumn.title">
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="page.layout">Layout: </label>

        <div class="controls" ng-controller="PageColumnTemplateCtrl">
          <div id="column_canvas" class="well well-small" style="margin-bottom: 0;">
            <ul class="template_widget_list">
              <li class="list-top" ng-class="{cursor: !cursorWidget}" id="widget_list_top"><div></div></li>
              <li ng-class="{boldit: isBold(widget), italicit: isItalic(widget), cursor: cursorWidget==widget, newline: widget.type=='newline'}" ng-repeat="widget in currentColumn.widgets">
                <judoon-widget-factory widget="widget">
              </li>
            </ul>
          </div>

          <div id="actions" class="row-fluid">
            <div class="span4">
              <h6>Add Elements <small> - <a ng-click="openElementGuide()">What is this?</a></small></h6>
              <div class="btn-group">
                <a class="btn" ng-click="addTextNode()">Text</a>
                <a class="btn" ng-click="addDataNode()">Data</a>
                <a class="btn" ng-click="addLinkNode()">Link</a>
                <a class="btn" ng-click="addImageNode()">Image</a>
                <a class="btn" ng-click="addNewlineNode()">Newline</a>
              </div>
            </div>

            <div class="span3">
              <h6>Move Cursor</h6>
              <div class="btn-group">
                <a class="btn" ng-click="cursorBack()"><i class="icon-arrow-left"></i> Back</a>
                <a class="btn" ng-click="cursorForward()"><i class="icon-arrow-right"></i> Forward</a>
              </div>
            </div>

            <div class="span2">
              <h6>Actions</h6>
              <div class="btn-group">
                <a class="btn" ng-click="removeNodeAtCursor()"><i class="icon-remove"></i> Delete</a>
              </div>
            </div>

            <div class="span3">
              <h6>&nbsp;</h6>
            </div>
          </div>

          <script type="text/ng-template" id="elementGuide.html">
            <div>
              <div class="modal-header">
                <h3>How this works.</h3>
              </div>
              <div class="modal-body">
                <p>
                  These buttons add elements to the canvas that let you control
                  how your data is displayed.
                </p>
                <h5>Element Guide</h5>
                <img src="/static/images/pagecolumn_components_labeled.png">
              </div>
              <div class="modal-footer">
                <button class="btn" ng-click="closeElementGuide()">Close</button>
              </div>
            </div>
          </script>

        </div>
      </div>

      <div class="control-group">
        <label class="control-label">Column Positioning: </label>
        <div class="controls">
          <a href="#" ng-click="columnLeft()"  ng-class="{disabled: firstColumn()}" class="btn"><i class="icon-arrow-left"></i> Move Left</a>
          <a href="#" ng-click="columnRight()" ng-class="{disabled: lastColumn()}" class="btn">Move Right <i class="icon-arrow-right"></i></a>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Column</button>
      </div>

    </form>
    <p ng-show="!currentColumn" class="text-center muted">No column selected.</p>
  </div>

    <judoon-data-table
       jdt-dataset-id="page.dataset_id"
       jdt-columns="pageColumns"
       jdt-header-key="title"
       jdt-fetch-fn="getServerData"
       highlight-active="columnIsActive(column)"
       highlight-delete="columnIsDelete(column)">
    </judoon-data-table>

  <br>

  <div ng-show="editmode" class="editable_label">Postamble:</div>
  <div judoon-ckeditor ck-edit-type="block" ng-class="{edit_outline: editmode}" ng-model="page.postamble" id="page_postamble" contenteditable="true" class="editable block_editable"></div>

</div>
